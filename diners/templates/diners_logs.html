{% extends 'base/base_nav_footer.html' %}
{% load static %}

{% block content %}
<div class="container-fluid container-diners">
  <div class="row mb-2">
    <div class="form-inline col-xs-12 col-lg-4 diners-id-form mb-1">
      <div class="input-group">
        <div class="input-group-addon"><i class="material-icons">search</i></div>
        <input type="text" class="form-control" id="input-diners-search" placeholder="Buscar Comensal por ID">
      </div>
    </div>
    <div class="col-xs-12 col-lg-8 text-xs-right  inputs-container">
      <div class="row">
        <form class="form-inline col-xs-12 " id="dates-range-form">
          <div class="col-xs-12 col-lg-3 container-select">
            <select class="custom-select col-xs-12" id="dt-year">
            </select>
          </div>
          <div class="col-xs-12 col-lg-9 container-select">
            <select class="custom-select col-xs-12" id="dt-week" >
            </select>
          </div>
        </form>
      </div>
    </div>
     
  </div>
  <div class="row">
    <div class="col-xs-12 col-lg-6">
      <div class="canvas-holder">
        <canvas id="dinners_by_day"></canvas>
      </div>
    </div>
    <div class="col-xs-12 col-lg-6">
      <div class="canvas-holder">
        <canvas id="dinners_by_hour"></canvas>
      </div>
    </div>         
  </div> 
  <div class="row mt-2">
    <div class="col-xs-12">
      <h3 class="col-xs-12 col-sm-8 col-xl-10">Comensales hasta hoy: <span class="badge badge-blue">{{ total_diners }}</span></h3>
      <button id="btn-save-ticket-csv" class="col-xs-12 col-sm-4 col-xl-2 btn btn-primary d-flex">
        <span class="btn-reports d-flex align-items-center"><i class="material-icons">file_download</i>Generar Reporte</span>
      </button>
    </div>

  </div>
  <div class="row">
    <div class="col-xs-12">
      <div class="card card-scroll-x mt-1">
        <table class="table" id="access-logs-table">
          <thead class="thead-inverse">
            <tr>
              <th>RFID</th>
              <th>SAP</th>
              <th>Nombre</th>
              <th>Fecha de Acceso</th>                 
            </tr>
          </thead>      
          <tbody>      
            {%for diner in diners %}        
            <tr>       
              <th>{{ diner.RFID }}</th> 
              <td>{{ diner.diner.employee_number }}</td>          
              <td>{{ diner.diner.name }}</td>          
              <td>{{ diner.access_to_room }}</td>
            </tr>      
            {% endfor %}        
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div> 
{% endblock %} 

{% block javascript %}

<script src="{% static 'js/Chart.bundle.min.js' %}" defer></script>
<script src="{% static 'js/papaparse.min.js' %}" defer></script>
<script src="{% static 'js/blob.js' %}" defer></script>
<script src="{% static 'js/fileSaver.min.js' %}" defer></script>

<script type="text/javascript" charset="utf-8" async>
  $(function() {
    var ctx_diners_hour = document.getElementById("dinners_by_hour");
    var ctx_diners_day = document.getElementById("dinners_by_day");
    var diners_hour = JSON.parse('{{ diners_hour | safe }}');
    var diners_week = JSON.parse('{{ diners_week | safe }}');    
    var dates_range = JSON.parse('{{ dates_range | safe }}');
    console.log(dates_range);


    function convert_date_to_str(date) {
      months = {
        1: 'Ene', 2: 'Feb', 3: 'Mar', 4: 'Abr', 5: 'May', 6: 'Jun',
        7: 'Jul', 8: 'Ago', 9: 'Sep', 10: 'Oct', 11: 'Nov', 12: 'Dic', 
      }
      date = date.split('-')
      fdate = date[0] + " " + months[parseInt(date[1])] + " " + date[2];
      return fdate;
    }

    function get_hours_of_diners() {
      var count_list = [];
      var count = 0;

      while (count < diners_hour.length) {
        count_list.push(parseFloat(diners_hour[count].count));
        count++;
      }
      return count_list;
    }

    function get_diners_day() {
      var entries_list = [];
      var count = 0;

      while (count < diners_week.length) {
        entries_list.push(parseFloat(diners_week[count].entries));
        count++;
      }
      return entries_list;
    }

    var chart_days = new Chart(ctx_diners_day, {
      type: 'bar',
      data: {
        labels: ["Lunes", "Martes", "Miercoles", "Juevez", "Viernes", "Sabado", "Domingo"],
        datasets: [{
          label: 'Comensales por dia',
          data: get_diners_day(),
          backgroundColor: [
            'rgba(255, 99, 132, 0.2)',
            'rgba(54, 162, 235, 0.2)',
            'rgba(255, 206, 86, 0.2)',
            'rgba(75, 192, 192, 0.2)',
            'rgba(153, 102, 255, 0.2)',
            'rgba(255, 206, 86, 0.2)',
            'rgba(255, 159, 64, 0.2)'
          ],
          borderColor: [
            'rgba(255,99,132,1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(255, 159, 64, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true,
            },
          }]
        }
      }
    });

    var chart_hours = new Chart(ctx_diners_hour, {
      type: 'bar',
      data: {
        labels: ["05:00", "06:00", "07:00", "08:00", "09:00", "10:00", "11:00", "12:00"],
        datasets: [{
          label: 'Comensales por hora',
          data: get_hours_of_diners(),
          backgroundColor: [
            'rgba(255, 99, 132, 0.2)',
            'rgba(54, 162, 235, 0.2)',
            'rgba(255, 206, 86, 0.2)',
            'rgba(75, 192, 192, 0.2)',
            'rgba(153, 102, 255, 0.2)',
            'rgba(75, 192, 192, 0.2)',
            'rgba(75, 192, 192, 0.2)',
            'rgba(255, 159, 64, 0.2)'
          ],
          borderColor: [
            'rgba(255,99,132,1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true,
            },
          }]
        }
      }
    });

    function fill_dates_range_form() {
      var dates_range_form = $(this).find('#dt-year');
      var selected_year;
      $.each(dates_range, function(index, item) {
         $('#dates-range-form').find('#dt-year').append(
            "<option value=" + item.year + ">" + item.year + "</option>"
          );
      });

      selected_year = $('#dates-range-form').find('#dt-year').val();
      
      $.each(dates_range, function(index, item) {
        if (dates_range[index].year ==  selected_year) {
          $.each(dates_range[index].weeks_list, function(index, item) { 
            $('#dates-range-form').find('#dt-week').append(
              "<option value=" + item.start_date + "," + item.end_date + ">" + 
              "Semana " + item.week_number + ": " + 
              convert_date_to_str(item.start_date) +
              " - " + convert_date_to_str(item.end_date) +
              "</option>"
            );
          });
          return false;
        }
      });
      today_date = $('#dt-week').val().split(',')[1];    
    }

    /** 
     * Refresh the page with de dates of the year and week selected
     */
    $(this).on('click', '#dt-week', function(event) {
      dt_year = $('#dt-year').val();
      dt_week = $('#dt-week').val();

      $.ajax({
        url: "{% url 'diners:diners_logs' %}",
        type: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
          'dt_year': dt_year,
          'dt_week': dt_week,
          'type': 'diners_logs',
        },
        beforeSend: function(){
          swal({
            title: "Obteniendo registros",
            text: "Espere mientras obtenemos toda la información",
          });
          swal.enableLoading();
        },
        traditional: true,
        datatype: 'jsonp',
        success: function(result, status, XHR) {
          var list_length = result.length;
          var access_logs_table = $('#access-logs-table').find('tbody');
          access_logs_table.empty();
          console.log(result);
          swal({
            title: "Éxito",
            text: "Datos obtenidos",
            type: "info",
            timer: 750,
            showConfirmButton: false
          }).then(
          function(){},
          function(dismiss){}
          );
          for (var i = 0; i < list_length; i++) {
            access_logs_table.append("" +
              "<tr>" +
              "<th>" + result[i].rfid + "</th>" +
              "<td>" + result[i].SAP + "</td>" +
              "<td>" + result[i].name + "</td>" +
              "<td>" + result[i].access + "</td>" +
              "</tr>" +
            "");
          };

          for (var i = 0; i < sales_week.length; i++) {
            var sales_day_earnings_list = [];

            sales_week_earnings_list = get_earnings_week_range(sales_week);
            chart_days.data.datasets[0].data = sales_week_earnings_list;
            chart_days.update();
          };

        },
        error: function(result, jqXHR, textStatus, errorThrown) {
          console.log(result);
        },
        complete: function(result){
        }
      });
    });

    $(this).on('keyup', '#input-diners-search', function(event) {
      /** Declare variables */
      var input, filter, table, tr, td, i;
      input = document.getElementById("input-diners-search");
      filter = input.value.toUpperCase();
      table = document.getElementById("access-logs-table");
      tr = table.getElementsByTagName("tr");

      /** Loop through all table rows, and hide those who don't match the search query */
      for (i = 0; i < tr.length; i++) {
        td = tr[i].getElementsByTagName("td")[0];
        if (td) {
          if (td.innerHTML.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
          } else {
            tr[i].style.display = "none";
          }
        }
      }
    });

    $(this).on('click', '#btn-save-ticket-csv', function(event) {
      /**
       * Convert JSON TO CSV
       */
        var tickets_json = null
        $.ajax({
          url: "{% url 'diners:diners_logs %}",
          type: 'POST',
          dataType: 'json',
          data: {
            type: 'tickets',
            csrfmiddlewaretoken: '{{ csrf_token }}',
          },
          beforeSend: function(){
            swal({
                title: "Generando Excel",
                text: "Espere mientras obtenemos toda la información",
              });
            swal.enableLoading();
          },
          success: function(result, status, XHR) {
            ticket_details = Papa.unparse(result.ticket);
            // console.log(ticket_details);
            // typeof(ticket_details)
            // var tmpElemento = document.createElement('a');
            // var data_type = 'data:application/vnd.ms-excel';
            // tmpElemento.href = data_type + ', ' + ticket_details;
            // tmpElemento.download = 'Nombre_De_Mi_Excel.xls';
            // tmpElemento.click();

            var blob = new Blob([ ticket_details ], { 
              type: "text/csv;charset=UTF-8" }
              );
            var datetime = new Date();
            saveAs(blob, datetime + '.csv');

            swal({
              title: "Éxito",
              text: "Datos obtenidos",
              type: "info",
              timer: 750,
              showConfirmButton: false
            }).then(
              function(){},
              function(dismiss){}
            );
          },
          complete: function(result){
            setTimeout(function() {
            }, 750);
          }
        });
    });

    fill_dates_range_form();
    
});
</script>
{% endblock javascript %}